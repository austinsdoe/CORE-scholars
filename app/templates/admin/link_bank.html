{% extends 'layouts/base.html' %}
{% import 'macros/form_macros.html' as f %}
{% import 'macros/check_password.html' as check %}

{% block scripts %}
{% endblock %}

{% block content %}
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.3/jquery.min.js"></script> -->
    <script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
    <div class="ui stackable centered grid container">
        <div class="twelve wide column">
            <a class="ui basic compact button" href="{{ url_for('admin.index') }}">
                <i class="caret left icon"></i>
                Back to dashboard
            </a>
            <h2 class="ui header">
                Link Bank Account
                <div class="sub header">Link bank account to access student balances</div>
            </h2>

            {% set flashes = {
                'error':   get_flashed_messages(category_filter=['form-error']),
                'warning': get_flashed_messages(category_filter=['form-check-email']),
                'info':    get_flashed_messages(category_filter=['form-info']),
                'success': get_flashed_messages(category_filter=['form-success'])
            } %}

            <!-- TODO: Link Plaid -->
            <button id="link-btn" class="ui primary button">Link Bank Account</button>
            <br/><br/>
            <div id="app"> 
                <div class="box">
                    <button class="ui primary button" id="get-accounts-btn">Get Accounts</button>
                <div id="get-accounts-data"></div>
            </div>


            <script>
            (function($) {
                var handler = Plaid.create({
                    apiVersion: 'v2',
                    clientName: 'Plaid Walkthrough Demo',
                    env: '{{ plaid_environment }}',
                    product: ['transactions'],
                    key: '{{ plaid_public_key }}',
                    onSuccess: function(public_token) {
                        $.post('/admin/get_access_token', {public_token: public_token}, function() {
                            $('#container').fadeOut('fast', function() {
                                $('#intro').hide();
                                $('#app, #steps').fadeIn('slow');
                            });
                        });
                    },
                });

                $('#link-btn').on('click', function(e) {
                    handler.open();
                });
                $('#get-accounts-btn').on('click', function(e) {
                    $.get('/accounts', function(data) {
                        $('#get-accounts-data').slideUp(function() {
                            var html = '';
                            data.accounts.forEach(function(account, idx) {
                                html += '<div class="inner">';
                                html += '<strong>' + account.name +
                                        ' $' + (account.balances.available != null ? account.balances.available : account.balances.current) + '</strong><br>';
                                html += account.subtype + ' ' + account.mask;
                                html += '</div>';
                            });

                            $(this).html(html).slideDown();
                        });
                    });
                });
            })(jQuery);
            </script>
        </div>
    </div>

    
    

{% endblock %}
